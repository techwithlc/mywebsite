name: Send Weekly Newsletter

on:
  schedule:
    # Runs every Monday at 1:00 AM UTC (9:00 AM UTC+8)
    - cron: '0 1 * * 1'
  
  # Allow manual trigger from GitHub Actions tab
  workflow_dispatch:

jobs:
  send-newsletter:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: server/package-lock.json

      - name: Install dependencies
        run: |
          cd server
          npm ci

      - name: Send newsletter
        env:
          # PostgreSQL credentials
          POSTGRES_HOST: ${{ secrets.POSTGRES_HOST }}
          POSTGRES_PORT: ${{ secrets.POSTGRES_PORT }}
          POSTGRES_DATABASE: ${{ secrets.POSTGRES_DATABASE }}
          POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          
          # Email configuration
          EMAIL_HOST: ${{ secrets.EMAIL_HOST }}
          EMAIL_PORT: ${{ secrets.EMAIL_PORT }}
          EMAIL_USER: ${{ secrets.EMAIL_USER }}
          EMAIL_PASS: ${{ secrets.EMAIL_PASS }}
          EMAIL_FROM: ${{ secrets.EMAIL_FROM }}
          
          # API keys
          NEWS_API_KEY: ${{ secrets.NEWS_API_KEY }}
          PERPLEXITY_API_KEY: ${{ secrets.PERPLEXITY_API_KEY }}
          
          NODE_ENV: production
        run: |
          cd server
          node send-newsletter.js

      - name: Report success
        if: success()
        run: |
          echo "‚úÖ Newsletter sent successfully!"
          echo "üìß Sent at: $(date)"

      - name: Report failure
        if: failure()
        run: |
          echo "‚ùå Newsletter sending failed!"
          echo "‚è∞ Failed at: $(date)"

